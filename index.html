<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Amigo Secreto</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="./favicon.ico" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: url("./assets/fondo5.jpg") no-repeat center center fixed;
        background-size: cover;
        min-height: 80vh;
        font-family: "Segoe UI", sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .card {
        position: relative;
        z-index: 1;
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.45);
        width: 100%;
        max-width: 420px;
        animation: aparecer 0.8s ease;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 0;
      }

      .title {
        letter-spacing: 0.08em;
        text-transform: uppercase;
        text-shadow: 0 0 10px rgba(179, 18, 23, 0.5);
      }

      .muted {
        color: #6c757d;
      }
      .fade {
        animation: fadeSlide 0.4s ease both;
      }
      @keyframes fadeSlide {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes aparecer {
        from {
          opacity: 0;
          transform: scale(0.97);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .reveal {
        animation: revealZoom 0.6s ease both;
      }
      @keyframes revealZoom {
        0% {
          opacity: 0;
          transform: scale(0.6);
        }
        60% {
          opacity: 1;
          transform: scale(1.05);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
      .animar {
        animation: revelar 0.9s ease-out;
      }
      @keyframes revelar {
        0% {
          opacity: 0;
          transform: scale(0.3);
        }
        70% {
          opacity: 1;
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
      button {
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .swal2-popup {
        border-radius: 16px !important;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }
    </style>
  </head>

  <body class="d-flex align-items-center justify-content-center">
    <div class="card p-4 shadow" style="width: 80%; max-width: 420px">
      <!-- ADMIN -->
      <div class="text-end mb-2">
        <button
          class="btn btn-sm fw-semibold btn-outline-danger"
          onclick="mostrarAdmin()"
        >
          Admin
        </button>
      </div>

      <!-- INICIO -->
      <div id="pantallaInicio" class="fade">
        <h4 class="text-center mb-3 title">Amigo Secreto</h4>
        <p class="text-center muted">
          Ingresa tu nombre y descubre tu amigo secreto.
        </p>
        <button
          class="btn btn-outline-success fw-semibold w-100 mt-3"
          onclick="iniciarSorteo()"
        >
          Participar
        </button>
      </div>

      <!-- INGRESO -->
      <div id="pantallaIngreso" class="fade" style="display: none">
        <h6 class="text-center mb-3">Tus datos</h6>
        <input
          type="text"
          id="nombreInput"
          class="form-control mb-3"
          placeholder="Tu primer nombre"
        />
        <textarea
          id="interesesInput"
          class="form-control mb-3"
          rows="3"
          placeholder="Tus intereses, gustos o pistas para tu obsequio"
        ></textarea>
        <button
          class="btn btn-outline-success fw-semibold w-100"
          onclick="obtenerAmigo()"
        >
          Descubrir mi amigo secreto
        </button>
      </div>

      <!-- RESULTADO -->
      <div id="pantallaResultado" class="fade" style="display: none">
        <h6 class="text-center">Tu amigo secreto es:</h6>
        <h3 class="text-center text-success mt-3 reveal" id="resultado"></h3>
        <button class="btn btn-outline-dark w-100 mt-4" onclick="cerrarTurno()">
          Cerrar turno
        </button>
      </div>

      <!-- Bot贸n para ver a quien me toc贸 -->
      <button
        class="btn btn-outline-dark fw-semibold mb-3 w-100 mt-3"
        onclick="verHistorial()"
      >
        Historial
      </button>

      <!-- ADMIN PANEL -->
      <div id="pantallaAdmin" class="fade" style="display: none">
        <h6 class="text-center mb-3">Panel de administraci贸n</h6>
        <button
          class="btn btn-warning fw-semibold w-100 mb-2"
          onclick="resetearTodo()"
        >
          Resetear sorteo
        </button>
        <button
          class="btn btn-outline-danger fw-semibold w-100"
          onclick="cerrarAdmin()"
        >
          Cerrar
        </button>
      </div>

      <div class="alert alert-light mt-4 fade" style="font-size: 0.9rem">
        Requisito: Escribe solo tu primer nombre 
      </div>
    </div>

    <!-- Comienzan los scripts-->

    <script>
      const API_URL =
        "https://amigo-secreto-navidad-backend-production.up.railway.app";
      const CLAVE_ADMIN = "software";

      async function iniciarSorteo() {
        try {
          await fetch(`${API_URL}/sorteo`, { method: "POST" });
          pantalla("pantallaIngreso");
        } catch (error) {
          Swal.fire("Error", "No se pudo contactar con el servidor", "error");
        }
      }

      async function obtenerAmigo() {
        const nombre = document.getElementById("nombreInput").value.trim();
        const intereses = document
          .getElementById("interesesInput")
          .value.trim();

        if (!nombre || !intereses) {
          Swal.fire({
            icon: "warning",
            title: "Campos incompletos",
            text: "Debes escribir tu nombre y tus intereses",
          });
          return;
        }

        try {
          const respuesta = await fetch(`${API_URL}/participar`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nombre, intereses }),
          });

          const data = await respuesta.json();

          if (!respuesta.ok) {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: data.error || "Error en el servidor",
            });
            return;
          }

          // Guardar token en sessionStorage
          sessionStorage.setItem("tokenAmigoSecreto", data.token);

          // Mostrar resultado
          const resultado = document.getElementById("resultado");
          resultado.innerHTML = `
        <div class="text-center">
          <strong>${data.amigo}</strong><br>
          <small class="text-muted">${
            data.intereses || "Sin intereses registrados"
          }</small>
        </div>
      `;

          resultado.classList.remove("animar");
          void resultado.offsetWidth;
          resultado.classList.add("animar");

          await Swal.fire({
            title: "隆Tu amigo secreto es!",
            html: `<strong>${data.amigo}</strong><br><small>${
              data.intereses || "Sin intereses registrados"
            }</small>`,
            icon: "success",
            confirmButtonText: "Perfecto",
          });

          pantalla("pantallaResultado");
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Error de conexi贸n",
            text: "No se pudo conectar al servidor",
          });
        }
      }

      async function cerrarTurno() {
        pantalla("pantallaInicio");
      }

      async function verHistorial() {
        const token = sessionStorage.getItem("tokenAmigoSecreto");
        if (!token) {
          Swal.fire("Error", "A煤n no participaste o tu sesi贸n expir贸", "error");
          return;
        }

        try {
          const res = await fetch(`${API_URL}/historial`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token }),
          });

          const data = await res.json();

          if (!res.ok) {
            Swal.fire(
              "Error",
              data.error || "No se pudo consultar el historial",
              "error"
            );
            return;
          }

          Swal.fire({
            title: "Tu amigo secreto",
            html: `<strong>${data.amigo}</strong><br><br>
               <small><b>Intereses actualizados:</b></small><br>
               <em>${data.intereses || "A煤n no ha escrito sus intereses"}</em>`,
            icon: "info",
          });
        } catch (error) {
          Swal.fire("Error", "No se pudo conectar al servidor", "error");
        }
      }

      function pantalla(id) {
        [
          "pantallaInicio",
          "pantallaIngreso",
          "pantallaResultado",
          "pantallaAdmin",
        ].forEach((p) => (document.getElementById(p).style.display = "none"));
        document.getElementById(id).style.display = "block";
      }

      function mostrarAdmin() {
        const clave = prompt("Ingresa la clave de administrador:");
        if (clave === CLAVE_ADMIN) pantalla("pantallaAdmin");
        else alert("Clave incorrecta");
      }

      function cerrarAdmin() {
        pantalla("pantallaInicio");
      }

      async function resetearTodo() {
        const confirmacion = await Swal.fire({
          title: "驴Resetear sorteo?",
          text: "Se borrar谩n todas las asignaciones",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "S铆, resetear",
          cancelButtonText: "Cancelar",
          reverseButtons: true,
        });

        if (!confirmacion.isConfirmed) return;

        try {
          const res = await fetch(`${API_URL}/reset`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ clave: CLAVE_ADMIN }),
          });

          const data = await res.json();

          if (!res.ok) {
            Swal.fire("Error", data.error || "No autorizado", "error");
            return;
          }

          // Limpiar token de sessionStorage
          sessionStorage.removeItem("tokenAmigoSecreto");

          Swal.fire({
            title: "Sorteo reseteado",
            text: "Todo volvi贸 al estado inicial",
            icon: "success",
            timer: 2000,
            showConfirmButton: false,
          });
          pantalla("pantallaInicio");
        } catch (error) {
          alert("No se pudo resetear el sorteo");
        }
      }
    </script>
  </body>
</html>
